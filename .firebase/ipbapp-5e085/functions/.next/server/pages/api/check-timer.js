"use strict";(()=>{var a={};a.id=973,a.ids=[973],a.modules={5071:(a,b,c)=>{c.r(b),c.d(b,{broadcastEvent:()=>g,default:()=>f});var d=c(8338);let e=new Map;async function f(a,b){if("GET"!==a.method)return b.status(405).json({error:"Method not allowed"});let{socketId:c}=a.query;if(!c)return b.status(400).json({error:"socketId required"});b.setHeader("Content-Type","text/event-stream"),b.setHeader("Cache-Control","no-cache"),b.setHeader("Connection","keep-alive"),b.setHeader("X-Accel-Buffering","no");let f=(0,d.getGameState)();b.write(`data: ${JSON.stringify({type:"state:update",data:f})}

`),e.set(c,b);let g=(0,d.addStateListener)(a=>{try{b.write(`data: ${JSON.stringify({type:"state:update",data:a})}

`)}catch(a){console.error("[SSE] Error writing to connection:",a),e.delete(c),g()}});a.on("close",()=>{console.log(`[SSE] Client disconnected: ${c}`),e.delete(c),g(),b.end()});let h=setInterval(()=>{try{b.write(": ping\n\n")}catch(a){clearInterval(h),e.delete(c),g()}},3e4);a.on("close",()=>{clearInterval(h)})}function g(a,b){let c=JSON.parse(JSON.stringify(b||{})),d=JSON.stringify({type:a,data:c});"state:update"===a?(console.log(`[SSE] Broadcasting ${a} to ${e.size} connections`),console.log("[SSE] State data - validTokens:",c.validTokens,"status:",c.status,"round:",c.round)):console.log(`[SSE] Broadcasting ${a} to ${e.size} connections`,"data:",JSON.stringify(c).substring(0,200));let f=0;e.forEach((a,b)=>{try{a.write(`data: ${d}

`),f++}catch(a){console.error(`[SSE] Error broadcasting to ${b}:`,a),e.delete(b)}}),console.log(`[SSE] Successfully broadcasted to ${f} connections`)}},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5710:(a,b,c)=>{c.r(b),c.d(b,{config:()=>q,default:()=>p,handler:()=>s});var d={};c.r(d),c.d(d,{default:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(8338),j=c(5071);function k(a,b="info"){let c={timestamp:new Date().toLocaleTimeString("it-IT"),msg:a,type:b};(0,j.broadcastEvent)("admin:log",c),console.log(`[AdminLog] [${b.toUpperCase()}] ${a}`)}async function l(a){console.log("[CheckTimer] triggerGeneration called with state:",{status:a.status,participantsCount:Object.keys(a.participants||{}).length,participants:Object.keys(a.participants||{})});let b=new(c(8087))({auth:process.env.REPLICATE_API_TOKEN}),d=Object.values(a.participants||{});console.log("[CheckTimer] All participants:",d.map(a=>({id:a.id,token:a.token,name:a.name,promptType:typeof a.prompt,promptLength:"string"==typeof a.prompt?a.prompt.length:0,hasPrompt:!!a.prompt})));let e=d.filter(a=>{if(!a.prompt)return!1;let b=String(a.prompt||"").trim(),c=""!==b;return console.log(`[CheckTimer] Participant ${a.name} (${a.id}): prompt type=${typeof a.prompt}, length=${b.length}, valid=${c}`),c});if(console.log(`[CheckTimer] Found ${e.length} participants with valid prompts`),0===e.length){k("‚ö†Ô∏è Nessun prompt disponibile per la generazione","warning"),console.log("[CheckTimer] No participants with prompts, aborting generation");return}for(let a of(k(`üöÄ Avvio generazione immagini per ${e.length} partecipante/i...`,"info"),e))try{let d=String(a.prompt||"").trim();console.log(`[CheckTimer] Generating for ${a.name} (${a.id}), prompt length: ${d.length}`),k(`üìù Inizio generazione per ${a.name}: "${d.substring(0,50)}${d.length>50?"...":""}"`,"info");let e=Date.now(),f=await b.predictions.create({model:"black-forest-labs/flux-2-dev",input:{prompt:d,aspect_ratio:"1:1",output_format:"webp",output_quality:90}});k(`‚è≥ Predizione creata per ${a.name} (ID: ${f.id.substring(0,8)}...)`,"info");let g=0;for(;"succeeded"!==f.status&&"failed"!==f.status&&"canceled"!==f.status;)await new Promise(a=>setTimeout(a,2e3)),f=await b.predictions.get(f.id),++g%5==0&&k(`‚è≥ ${a.name}: generazione in corso... (${f.status}, tentativo ${g})`,"info");let h=((Date.now()-e)/1e3).toFixed(1);if("succeeded"===f.status){let{updateParticipant:b,getGameState:d}=c(8338),{broadcastEvent:e}=c(5071),g=Array.isArray(f.output)?f.output[0]:f.output;console.log(`[CheckTimer] Updating participant ${a.id} (${a.name}) with image URL:`,g),b(a.id,{image:g});let i=d();e("state:update",i),k(`‚úÖ Immagine generata con successo per ${a.name} (${h}s)`,"success")}else k(`‚ùå Generazione fallita per ${a.name}: ${f.status}`,"error")}catch(b){k(`‚ùå Errore durante la generazione per ${a.name}: ${b.message}`,"error"),console.error(`[CheckTimer] Error generating for ${a.name}:`,b),b.stack&&console.error("[CheckTimer] Error stack:",b.stack)}let{getGameState:f}=c(8338),{broadcastEvent:g}=c(5071);g("state:update",f()),k(`‚ú® Generazione completata per tutti i partecipanti`,"success"),console.log("[CheckTimer] Generation completed, final state broadcasted")}async function m(a,b){if(console.log("[CheckTimer] ====== ENDPOINT CALLED ======"),"GET"!==a.method)return console.log("[CheckTimer] Method not allowed:",a.method),b.status(405).json({error:"Method not allowed"});let c=(0,i.getGameState)();if(console.log("[CheckTimer] Called - status:",c.status,"isTimerRunning:",c.isTimerRunning,"timer:",c.timer,"generationTriggered:",c.generationTriggered,"timerStartTime:",c.timerStartTime),k(`üîç CheckTimer chiamato - Status: ${c.status}, Timer: ${c.timer}, Running: ${c.isTimerRunning}`,"info"),c.isTimerRunning&&c.timerStartTime&&"WRITING"===c.status){let a=Math.floor((Date.now()-c.timerStartTime)/1e3),d=Math.max(0,c.timer-a);if(console.log("[CheckTimer] Timer check - elapsed:",a,"original timer:",c.timer,"remaining:",d,"generationTriggered:",c.generationTriggered),k(`‚è±Ô∏è Timer check - Elapsed: ${a}s, Remaining: ${d}s`,"info"),d<=0&&!c.generationTriggered){console.log("[CheckTimer] ‚úÖ Timer reached zero, triggering generation"),k("‚è∞ Timer scaduto! Avvio generazione automatica...","info");let a=(0,i.updateGameState)({status:"GENERATING",isTimerRunning:!1,generationTriggered:!0});return console.log("[CheckTimer] State updated to GENERATING"),(0,j.broadcastEvent)("state:update",a),console.log("[CheckTimer] Starting triggerGeneration..."),l(a).catch(a=>{console.error("[CheckTimer] Generation error:",a),k(`‚ùå Errore critico durante la generazione: ${a.message}`,"error")}),b.status(200).json({success:!0,message:"Generation triggered",state:a})}d>0&&console.log("[CheckTimer] ‚è≥ Timer not yet zero, remaining:",d),c.generationTriggered&&(console.log("[CheckTimer] ‚ö†Ô∏è Generation already triggered"),k("‚ö†Ô∏è Generazione gi\xe0 in corso","warning"))}else{let a=[];c.isTimerRunning||(a.push("timer not running"),console.log("[CheckTimer] ‚ùå Timer not running")),c.timerStartTime||(a.push("no timerStartTime"),console.log("[CheckTimer] ‚ùå No timerStartTime")),"WRITING"!==c.status&&(a.push(`status is ${c.status}`),console.log("[CheckTimer] ‚ùå Status is not WRITING:",c.status)),c.generationTriggered&&(a.push("generation already triggered"),console.log("[CheckTimer] ‚ùå Generation already triggered")),k(`‚ö†Ô∏è Condizioni non soddisfatte: ${a.join(", ")}`,"warning")}return b.status(200).json({success:!0,timer:c.timer,status:c.status,isTimerRunning:c.isTimerRunning,generationTriggered:c.generationTriggered,timerStartTime:c.timerStartTime})}var n=c(8112),o=c(8766);let p=(0,h.M)(d,"default"),q=(0,h.M)(d,"config"),r=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/check-timer",pathname:"/api/check-timer",bundlePath:"",filename:""},userland:d,distDir:".next",relativeProjectDir:""});async function s(a,b,c){let d=await r.prepare(a,b,{srcPage:"/api/check-timer"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,n.getTracer)(),e=d.getActiveScopeSpan(),j=r.instrumentationOnRequestError.bind(r),k=async e=>r.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:r.isDev,page:"/api/check-timer",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>j(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==o.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await k(e):await d.withPropagatedContext(a.headers,()=>d.trace(o.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},k))}catch(a){if(r.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},6472:a=>{a.exports=require("@opentelemetry/api")},8087:a=>{a.exports=require("replicate")},8338:(a,b,c)=>{c.r(b),c.d(b,{addParticipant:()=>n,addStateListener:()=>k,getGameState:()=>h,getParticipantBySocketId:()=>s,getParticipantByToken:()=>r,getTokenBySocketId:()=>t,removeParticipant:()=>o,setGameState:()=>j,setOnTimerZeroCallback:()=>g,updateGameState:()=>i,updateParticipant:()=>p,updateParticipantBySocketId:()=>q});let d={round:0,theme:"",timer:60,isTimerRunning:!1,status:"IDLE",participants:{},validTokens:[],expectedParticipantCount:0,votingTimer:120,timerStartTime:null,votingTimerStartTime:null,generationTriggered:!1},e=new Set,f=null,g=a=>{f=a},h=()=>{let a={...d};if(a.isTimerRunning&&a.timerStartTime){let b=Math.floor((Date.now()-a.timerStartTime)/1e3),c=Math.max(0,a.timer-b);a.timer=c,c<=0&&"WRITING"===a.status&&!a.generationTriggered&&(console.log("[GameState] Timer reached zero in getGameState(), triggering generation"),a.isTimerRunning=!1,a.status="GENERATING",a.generationTriggered=!0,d={...d,...a},f?(console.log("[GameState] Calling onTimerZeroCallback"),f(a).catch(a=>{console.error("[GameState] Error triggering generation:",a)})):console.warn("[GameState] No onTimerZeroCallback set!"),l())}if("VOTING"===a.status&&a.votingTimerStartTime){let b=Math.floor((Date.now()-a.votingTimerStartTime)/1e3),c=Math.max(0,a.votingTimer-b);a.votingTimer=c,0===c&&(a.status="ENDED")}return a},i=a=>(d={...d,...a},("WAITING_FOR_PLAYERS"===a.status||"WRITING"===a.status)&&(d.generationTriggered=!1),"WAITING_FOR_PLAYERS"===a.status&&a.participants&&0===Object.keys(a.participants).length&&(console.log("[GameState] New round started, clearing tokenToSocketIdMap and resetting sessionSecrets"),m={}),a.validTokens&&console.log("[GameState] Valid tokens updated:",a.validTokens),l(),d),j=a=>(d={...a},l(),d),k=a=>(e.add(a),()=>e.delete(a)),l=()=>{let a=h();e.forEach(b=>{try{b(a)}catch(a){console.error("Error in state listener:",a)}})},m={},n=(a,b,c=null)=>{let e=b.token;if(!e)return console.error("[GameState] Cannot add participant without token"),d;let f=d.participants[e];if(f){if(c){if(f.sessionSecret!==c)throw console.error(`[GameState] Rejoin rejected: sessionSecret mismatch for token ${e}`),Error("INVALID_SESSION_SECRET");console.log(`[GameState] Valid rejoin for token ${e}, updating socketId from ${f.socketId} to ${a}`)}else throw console.error(`[GameState] Rejoin rejected: no sessionSecret provided for existing token ${e}`),Error("SESSION_SECRET_REQUIRED");let b=f.socketId;b&&m[b]===e&&delete m[b]}else b.sessionSecret=`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}_${Math.random().toString(36).substring(2,15)}`,console.log(`[GameState] New participant, generated sessionSecret for token ${e}`);return d.participants[e]={...b,socketId:a,id:e,sessionSecret:f?.sessionSecret||b.sessionSecret},m[a]=e,console.log(`[GameState] Participant added/updated: token=${e}, socketId=${a}, total participants: ${Object.keys(d.participants).length}`),l(),d},o=a=>{let b=m[a];return b&&d.participants[b]&&(delete d.participants[b],delete m[a],console.log(`[GameState] Participant removed: token=${b}, socketId=${a}`),l()),d},p=(a,b)=>(d.participants[a]?(d.participants[a]={...d.participants[a],...b},l()):console.warn(`[GameState] Cannot update participant: token ${a} not found`),d),q=(a,b)=>{let c=m[a];return c?p(c,b):(console.warn(`[GameState] Cannot update participant: socketId ${a} not found in mapping`),d)},r=a=>d.participants[a]||null,s=a=>{let b=m[a];return b?d.participants[b]:null},t=a=>m[a]||null}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=5710));module.exports=c})();