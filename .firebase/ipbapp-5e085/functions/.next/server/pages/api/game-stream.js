"use strict";(()=>{var a={};a.id=322,a.ids=[322],a.modules={5071:(a,b,c)=>{c.r(b),c.d(b,{broadcastEvent:()=>g,default:()=>f});var d=c(8338);let e=new Map;async function f(a,b){if("GET"!==a.method)return b.status(405).json({error:"Method not allowed"});let{socketId:c}=a.query;if(!c)return b.status(400).json({error:"socketId required"});b.setHeader("Content-Type","text/event-stream"),b.setHeader("Cache-Control","no-cache"),b.setHeader("Connection","keep-alive"),b.setHeader("X-Accel-Buffering","no");let f=(0,d.getGameState)();b.write(`data: ${JSON.stringify({type:"state:update",data:f})}

`),e.set(c,b);let g=(0,d.addStateListener)(a=>{try{b.write(`data: ${JSON.stringify({type:"state:update",data:a})}

`)}catch(a){console.error("[SSE] Error writing to connection:",a),e.delete(c),g()}});a.on("close",()=>{console.log(`[SSE] Client disconnected: ${c}`),e.delete(c),g(),b.end()});let h=setInterval(()=>{try{b.write(": ping\n\n")}catch(a){clearInterval(h),e.delete(c),g()}},3e4);a.on("close",()=>{clearInterval(h)})}function g(a,b){let c=JSON.parse(JSON.stringify(b||{})),d=JSON.stringify({type:a,data:c});"state:update"===a?(console.log(`[SSE] Broadcasting ${a} to ${e.size} connections`),console.log("[SSE] State data - validTokens:",c.validTokens,"status:",c.status,"round:",c.round)):console.log(`[SSE] Broadcasting ${a} to ${e.size} connections`,"data:",JSON.stringify(c).substring(0,200));let f=0;e.forEach((a,b)=>{try{a.write(`data: ${d}

`),f++}catch(a){console.error(`[SSE] Error broadcasting to ${b}:`,a),e.delete(b)}}),console.log(`[SSE] Successfully broadcasted to ${f} connections`)}},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5964:(a,b,c)=>{c.r(b),c.d(b,{config:()=>l,default:()=>k,handler:()=>n});var d=c(9046),e=c(8667),f=c(3480),g=c(6435),h=c(5071),i=c(8112),j=c(8766);let k=(0,g.M)(h,"default"),l=(0,g.M)(h,"config"),m=new f.PagesAPIRouteModule({definition:{kind:e.A.PAGES_API,page:"/api/game-stream",pathname:"/api/game-stream",bundlePath:"",filename:""},userland:h,distDir:".next",relativeProjectDir:""});async function n(a,b,c){let e=await m.prepare(a,b,{srcPage:"/api/game-stream"});if(!e){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:k}=e;try{let c=a.method||"GET",d=(0,i.getTracer)(),e=d.getActiveScopeSpan(),l=m.instrumentationOnRequestError.bind(m),n=async e=>m.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:m.isDev,page:"/api/game-stream",internalRevalidate:null==k?void 0:k.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==j.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await n(e):await d.withPropagatedContext(a.headers,()=>d.trace(j.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},n))}catch(a){if(m.isDev)throw a;(0,d.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},6472:a=>{a.exports=require("@opentelemetry/api")},8338:(a,b,c)=>{c.r(b),c.d(b,{addParticipant:()=>n,addStateListener:()=>k,getGameState:()=>h,getParticipantBySocketId:()=>s,getParticipantByToken:()=>r,getTokenBySocketId:()=>t,removeParticipant:()=>o,setGameState:()=>j,setOnTimerZeroCallback:()=>g,updateGameState:()=>i,updateParticipant:()=>p,updateParticipantBySocketId:()=>q});let d={round:0,theme:"",timer:60,isTimerRunning:!1,status:"IDLE",participants:{},validTokens:[],expectedParticipantCount:0,votingTimer:120,timerStartTime:null,votingTimerStartTime:null,generationTriggered:!1},e=new Set,f=null,g=a=>{f=a},h=()=>{let a={...d};if(a.isTimerRunning&&a.timerStartTime){let b=Math.floor((Date.now()-a.timerStartTime)/1e3),c=Math.max(0,a.timer-b);a.timer=c,c<=0&&"WRITING"===a.status&&!a.generationTriggered&&(console.log("[GameState] Timer reached zero in getGameState(), triggering generation"),a.isTimerRunning=!1,a.status="GENERATING",a.generationTriggered=!0,d={...d,...a},f?(console.log("[GameState] Calling onTimerZeroCallback"),f(a).catch(a=>{console.error("[GameState] Error triggering generation:",a)})):console.warn("[GameState] No onTimerZeroCallback set!"),l())}if("VOTING"===a.status&&a.votingTimerStartTime){let b=Math.floor((Date.now()-a.votingTimerStartTime)/1e3),c=Math.max(0,a.votingTimer-b);a.votingTimer=c,0===c&&(a.status="ENDED")}return a},i=a=>(d={...d,...a},("WAITING_FOR_PLAYERS"===a.status||"WRITING"===a.status)&&(d.generationTriggered=!1),"WAITING_FOR_PLAYERS"===a.status&&a.participants&&0===Object.keys(a.participants).length&&(console.log("[GameState] New round started, clearing tokenToSocketIdMap and resetting sessionSecrets"),m={}),a.validTokens&&console.log("[GameState] Valid tokens updated:",a.validTokens),l(),d),j=a=>(d={...a},l(),d),k=a=>(e.add(a),()=>e.delete(a)),l=()=>{let a=h();e.forEach(b=>{try{b(a)}catch(a){console.error("Error in state listener:",a)}})},m={},n=(a,b,c=null)=>{let e=b.token;if(!e)return console.error("[GameState] Cannot add participant without token"),d;let f=d.participants[e];if(f){if(c){if(f.sessionSecret!==c)throw console.error(`[GameState] Rejoin rejected: sessionSecret mismatch for token ${e}`),Error("INVALID_SESSION_SECRET");console.log(`[GameState] Valid rejoin for token ${e}, updating socketId from ${f.socketId} to ${a}`)}else throw console.error(`[GameState] Rejoin rejected: no sessionSecret provided for existing token ${e}`),Error("SESSION_SECRET_REQUIRED");let b=f.socketId;b&&m[b]===e&&delete m[b]}else b.sessionSecret=`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}_${Math.random().toString(36).substring(2,15)}`,console.log(`[GameState] New participant, generated sessionSecret for token ${e}`);return d.participants[e]={...b,socketId:a,id:e,sessionSecret:f?.sessionSecret||b.sessionSecret},m[a]=e,console.log(`[GameState] Participant added/updated: token=${e}, socketId=${a}, total participants: ${Object.keys(d.participants).length}`),l(),d},o=a=>{let b=m[a];return b&&d.participants[b]&&(delete d.participants[b],delete m[a],console.log(`[GameState] Participant removed: token=${b}, socketId=${a}`),l()),d},p=(a,b)=>(d.participants[a]?(d.participants[a]={...d.participants[a],...b},l()):console.warn(`[GameState] Cannot update participant: token ${a} not found`),d),q=(a,b)=>{let c=m[a];return c?p(c,b):(console.warn(`[GameState] Cannot update participant: socketId ${a} not found in mapping`),d)},r=a=>d.participants[a]||null,s=a=>{let b=m[a];return b?d.participants[b]:null},t=a=>m[a]||null}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=5964));module.exports=c})();