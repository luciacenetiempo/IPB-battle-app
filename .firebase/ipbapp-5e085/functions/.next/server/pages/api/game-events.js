"use strict";(()=>{var a={};a.id=857,a.ids=[857],a.modules={5071:(a,b,c)=>{c.r(b),c.d(b,{broadcastEvent:()=>g,default:()=>f});var d=c(8338);let e=new Map;async function f(a,b){if("GET"!==a.method)return b.status(405).json({error:"Method not allowed"});let{socketId:c}=a.query;if(!c)return b.status(400).json({error:"socketId required"});b.setHeader("Content-Type","text/event-stream"),b.setHeader("Cache-Control","no-cache"),b.setHeader("Connection","keep-alive"),b.setHeader("X-Accel-Buffering","no");let f=(0,d.getGameState)();b.write(`data: ${JSON.stringify({type:"state:update",data:f})}

`),e.set(c,b);let g=(0,d.addStateListener)(a=>{try{b.write(`data: ${JSON.stringify({type:"state:update",data:a})}

`)}catch(a){console.error("[SSE] Error writing to connection:",a),e.delete(c),g()}});a.on("close",()=>{console.log(`[SSE] Client disconnected: ${c}`),e.delete(c),g(),b.end()});let h=setInterval(()=>{try{b.write(": ping\n\n")}catch(a){clearInterval(h),e.delete(c),g()}},3e4);a.on("close",()=>{clearInterval(h)})}function g(a,b){let c=JSON.parse(JSON.stringify(b||{})),d=JSON.stringify({type:a,data:c});"state:update"===a?(console.log(`[SSE] Broadcasting ${a} to ${e.size} connections`),console.log("[SSE] State data - validTokens:",c.validTokens,"status:",c.status,"round:",c.round)):console.log(`[SSE] Broadcasting ${a} to ${e.size} connections`,"data:",JSON.stringify(c).substring(0,200));let f=0;e.forEach((a,b)=>{try{a.write(`data: ${d}

`),f++}catch(a){console.error(`[SSE] Error broadcasting to ${b}:`,a),e.delete(b)}}),console.log(`[SSE] Successfully broadcasted to ${f} connections`)}},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6472:a=>{a.exports=require("@opentelemetry/api")},6736:(a,b,c)=>{c.r(b),c.d(b,{config:()=>q,default:()=>p,handler:()=>s});var d={};c.r(d),c.d(d,{default:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(8338),j=c(5071);function k(a,b="info"){let c={timestamp:new Date().toLocaleTimeString("it-IT"),msg:a,type:b};(0,j.broadcastEvent)("admin:log",c),console.log(`[AdminLog] [${b.toUpperCase()}] ${a}`)}async function l(a){console.log("[GameEvents] triggerGeneration called with state:",{status:a.status,participantsCount:Object.keys(a.participants||{}).length,participants:Object.keys(a.participants||{})});let b=new(c(8087))({auth:process.env.REPLICATE_API_TOKEN}),d=Object.values(a.participants||{});console.log("[GameEvents] All participants:",d.map(a=>({id:a.id,token:a.token,name:a.name,promptType:typeof a.prompt,promptLength:"string"==typeof a.prompt?a.prompt.length:0,hasPrompt:!!a.prompt})));let e=d.filter(a=>{if(!a.prompt)return!1;let b=String(a.prompt||"").trim(),c=""!==b;return console.log(`[GameEvents] Participant ${a.name} (${a.id}): prompt type=${typeof a.prompt}, length=${b.length}, valid=${c}`),c});if(console.log(`[GameEvents] Found ${e.length} participants with valid prompts`),0===e.length){k("‚ö†Ô∏è Nessun prompt disponibile per la generazione","warning"),console.log("[GameEvents] No participants with prompts, aborting generation");return}for(let a of(k(`üöÄ Avvio generazione immagini per ${e.length} partecipante/i...`,"info"),e))try{let d=String(a.prompt||"").trim();console.log(`[GameEvents] Generating for ${a.name} (${a.id}), prompt length: ${d.length}`),k(`üìù Inizio generazione per ${a.name}: "${d.substring(0,50)}${d.length>50?"...":""}"`,"info");let e=Date.now(),f=await b.predictions.create({model:"black-forest-labs/flux-2-dev",input:{prompt:d,aspect_ratio:"1:1",output_format:"webp",output_quality:90}});k(`‚è≥ Predizione creata per ${a.name} (ID: ${f.id.substring(0,8)}...)`,"info");let g=0;for(;"succeeded"!==f.status&&"failed"!==f.status&&"canceled"!==f.status;)await new Promise(a=>setTimeout(a,2e3)),f=await b.predictions.get(f.id),++g%5==0&&k(`‚è≥ ${a.name}: generazione in corso... (${f.status}, tentativo ${g})`,"info");let h=((Date.now()-e)/1e3).toFixed(1);if("succeeded"===f.status){let{updateParticipant:b}=c(8338),d=Array.isArray(f.output)?f.output[0]:f.output;console.log(`[GameEvents] Updating participant ${a.id} (${a.name}) with image URL:`,d),b(a.id,{image:d});let e=c(8338).getGameState();(0,j.broadcastEvent)("state:update",e),k(`‚úÖ Immagine generata con successo per ${a.name} (${h}s)`,"success")}else k(`‚ùå Generazione fallita per ${a.name}: ${f.status}`,"error")}catch(b){k(`‚ùå Errore durante la generazione per ${a.name}: ${b.message}`,"error"),console.error(`[GameEvents] Error generating for ${a.name}:`,b),b.stack&&console.error("[GameEvents] Error stack:",b.stack)}let f=c(8338).getGameState();(0,j.broadcastEvent)("state:update",f),k(`‚ú® Generazione completata per tutti i partecipanti`,"success"),console.log("[GameEvents] Generation completed, final state broadcasted")}async function m(a,b){let{method:c}=a,{action:d,socketId:e,data:f}=a.body||{};if("POST"!==c)return b.status(405).json({error:"Method not allowed"});if("POST"===c){if(!d||!e)return b.status(400).json({error:"action and socketId required"});let a=(0,i.getGameState)(),c=a,g=!1;switch(d){case"admin:start_round":let h=f.participantCount||2,m=function(a){let b=[],c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";for(let d=0;d<a;d++){let a="";for(let b=0;b<4;b++)a+=c.charAt(Math.floor(Math.random()*c.length));b.push(a)}return console.log("[GameEvents] Generated",a,"tokens:",b),b}(h);console.log("[GameEvents] Starting round - generating tokens:",m),k(`üéÆ Round ${a.round+1} avviato - Token generati: ${m.join(", ")}`,"info"),c=(0,i.updateGameState)({round:a.round+1,theme:f.theme,status:"WAITING_FOR_PLAYERS",timer:f.timer||60,isTimerRunning:!1,expectedParticipantCount:h,validTokens:m,participants:{},timerStartTime:null,votingTimerStartTime:null,generationTriggered:!1}),g=!0;break;case"admin:stop_timer":c=(0,i.updateGameState)({isTimerRunning:!1,timerStartTime:null}),g=!0;break;case"admin:trigger_generation":k("\uD83D\uDD27 Generazione avviata manualmente dall'admin","info"),c=(0,i.updateGameState)({status:"GENERATING",isTimerRunning:!1,timerStartTime:null}),g=!0,l(c).catch(a=>{console.error("[GameEvents] Generation error:",a),k(`‚ùå Errore critico durante la generazione: ${a.message}`,"error")});break;case"join_room":return b.status(200).json({success:!0,state:a});case"admin:start_voting":c=(0,i.updateGameState)({status:"VOTING",votingTimer:120,votingTimerStartTime:Date.now()}),g=!0;break;case"participant:join":if(console.log("[GameEvents] participant:join request:",{socketId:e,token:f.token,name:f.name}),console.log("[GameEvents] Current state:",{validTokens:a.validTokens,validTokensLength:a.validTokens?a.validTokens.length:0,participantsCount:Object.keys(a.participants).length,status:a.status,expectedCount:a.expectedParticipantCount,round:a.round}),"IDLE"===a.status)return console.error("[GameEvents] Cannot join: Game is in IDLE state. A round must be started first."),k("‚ö†Ô∏è Impossibile unirsi: il gioco \xe8 in stato IDLE. Avvia prima un round dall'admin.","error"),b.status(400).json({error:"GAME_NOT_STARTED",message:"Il gioco non \xe8 stato ancora avviato. Attendi che l'admin avvii un round."});if(!a.validTokens||0===a.validTokens.length)return console.error("[GameEvents] No valid tokens available. State:",JSON.stringify({status:a.status,round:a.round,validTokens:a.validTokens,expectedCount:a.expectedParticipantCount},null,2)),k(`‚ö†Ô∏è Errore: Nessun token disponibile (Status: ${a.status}, Round: ${a.round}). Assicurati di aver avviato un round.`,"error"),b.status(400).json({error:"NO_TOKENS_AVAILABLE",message:"Nessun token disponibile. Assicurati che l'admin abbia avviato un round.",state:{status:a.status,round:a.round}});if(!f.token||!a.validTokens.includes(f.token.toUpperCase()))return console.error("[GameEvents] Invalid token:",f.token,"Valid tokens:",a.validTokens),b.status(400).json({error:"INVALID TOKEN"});let n=f.token.toUpperCase(),o=(0,i.getParticipantByToken)(n),p=f.sessionSecret||null;if(o)try{console.log(`[GameEvents] Token ${n} already exists, attempting rejoin with sessionSecret: ${p?"provided":"missing"}`),c=(0,i.addParticipant)(e,{id:n,token:n,name:f.name||o.name,prompt:o.prompt||"",image:o.image||null,votes:o.votes||0,color:o.color,socketId:e},p),k(`üîÑ ${o.name} si \xe8 riconnesso (token: ${n})`,"info"),g=!0,(0,j.broadcastEvent)("participant:joined",{id:n,token:n,name:c.participants[n].name,color:c.participants[n].color,sessionSecret:c.participants[n].sessionSecret});break}catch(a){if("INVALID_SESSION_SECRET"===a.message||"SESSION_SECRET_REQUIRED"===a.message)return console.error(`[GameEvents] Rejoin rejected for token ${n}: ${a.message}`),k(`‚ö†Ô∏è Tentativo di rejoin non autorizzato per token ${n}`,"warning"),b.status(403).json({error:"UNAUTHORIZED_REJOIN",message:"Token gi\xe0 in uso. Non puoi riconnetterti senza la sessione originale."});throw a}let q=["#BEFA4F","#E83399","#5AA7B9","#F5B700"],r=Object.keys(a.participants).length,s=q[r%q.length];if(console.log("[GameEvents] Adding new participant:",{socketId:e,token:n,name:f.name,index:r}),console.log("[GameEvents] Participant added. New participants count:",Object.keys((c=(0,i.addParticipant)(e,{id:n,token:n,name:f.name||`Player ${r+1}`,prompt:"",image:null,votes:0,color:s,socketId:e})).participants).length),k(`‚úÖ ${f.name||`Player ${r+1}`} si \xe8 unito (token: ${n})`,"success"),Object.keys(c.participants).length===c.expectedParticipantCount&&"WAITING_FOR_PLAYERS"===c.status){console.log("[GameEvents] All participants joined, starting WRITING phase");let a=Date.now();c=(0,i.updateGameState)({status:"WRITING",isTimerRunning:!0,timerStartTime:a}),(0,j.broadcastEvent)("state:update",c)}(0,j.broadcastEvent)("participant:joined",{id:n,token:n,name:c.participants[n].name,color:s,sessionSecret:c.participants[n].sessionSecret}),g=!0;break;case"participant:update_prompt":let t,u=(0,i.getTokenBySocketId)(e);if(!u)return console.warn(`[GameEvents] Cannot update prompt: socketId ${e} not found in token mapping`),b.status(400).json({error:"PARTICIPANT_NOT_FOUND"});if(!(0,i.getParticipantByToken)(u)||"WRITING"!==a.status)return console.warn(`[GameEvents] Cannot update prompt: participant not found or status is not WRITING (status: ${a.status})`),b.status(400).json({error:"INVALID_STATE"});t=String((t="string"==typeof f?f:f&&"object"==typeof f?"string"==typeof f.prompt?f.prompt:f.prompt&&"object"==typeof f.prompt&&"string"==typeof f.prompt.prompt?f.prompt.prompt:"":"")||""),console.log("[GameEvents] participant:update_prompt received:",{token:u,socketId:e,promptType:typeof f,promptLength:t.length,promptPreview:t.substring(0,50)}),c=(0,i.updateParticipant)(u,{prompt:t}),console.log("[GameEvents] Participant updated. Verifying prompt was saved:",{token:u,savedPrompt:c.participants[u]?.prompt,savedPromptType:typeof c.participants[u]?.prompt,savedPromptLength:"string"==typeof c.participants[u]?.prompt?c.participants[u].prompt.length:0});let v={id:u,token:u,prompt:t};console.log("[GameEvents] Broadcasting prompt:update:",v),(0,j.broadcastEvent)("prompt:update",v);let w=Date.now(),x=w-(gameState._lastPromptBroadcast||0);x>200?(g=!0,gameState._lastPromptBroadcast=w,c._lastPromptBroadcast=w):(gameState._pendingPromptBroadcast&&clearTimeout(gameState._pendingPromptBroadcast),gameState._pendingPromptBroadcast=setTimeout(()=>{let a=(0,i.getGameState)();(0,j.broadcastEvent)("state:update",a),gameState._lastPromptBroadcast=Date.now(),gameState._pendingPromptBroadcast=null},200-x));break;case"vote:cast":let y=null,z=null;a.participants[f.participantId]?(y=a.participants[f.participantId],z=f.participantId):(z=(0,i.getTokenBySocketId)(f.participantId))&&(y=(0,i.getParticipantByToken)(z)),"VOTING"===a.status&&y&&z?(c=(0,i.updateParticipant)(z,{votes:(y.votes||0)+1}),g=!0,console.log(`[GameEvents] Vote cast for ${y.name} (token: ${z}), new votes: ${c.participants[z].votes}`)):console.warn(`[GameEvents] Cannot cast vote: participant not found or invalid state (status: ${a.status})`);break;default:return b.status(400).json({error:"Unknown action"})}g&&(console.log("[GameEvents] Broadcasting state update, validTokens:",c.validTokens),(0,j.broadcastEvent)("state:update",c));let A=(0,i.getGameState)();return console.log("[GameEvents] Returning state with validTokens:",A.validTokens),b.status(200).json({success:!0,state:A})}return b.status(405).json({error:"Method not allowed"})}(0,i.setOnTimerZeroCallback)(async a=>{console.log("[GameEvents] Timer reached zero callback called, triggering generation automatically"),console.log("[GameEvents] State passed to callback:",{status:a.status,participantsCount:Object.keys(a.participants||{}).length}),k("‚è∞ Timer scaduto! Avvio generazione automatica (via callback)...","info");let b=(0,i.getGameState)();console.log("[GameEvents] Using current state for generation:",{status:b.status,participantsCount:Object.keys(b.participants||{}).length}),await l(b);let c=(0,i.getGameState)();(0,j.broadcastEvent)("state:update",c)}),console.log("[GameEvents] onTimerZeroCallback configured");var n=c(8112),o=c(8766);let p=(0,h.M)(d,"default"),q=(0,h.M)(d,"config"),r=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/game-events",pathname:"/api/game-events",bundlePath:"",filename:""},userland:d,distDir:".next",relativeProjectDir:""});async function s(a,b,c){let d=await r.prepare(a,b,{srcPage:"/api/game-events"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,n.getTracer)(),e=d.getActiveScopeSpan(),j=r.instrumentationOnRequestError.bind(r),k=async e=>r.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:r.isDev,page:"/api/game-events",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>j(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==o.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await k(e):await d.withPropagatedContext(a.headers,()=>d.trace(o.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},k))}catch(a){if(r.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},8087:a=>{a.exports=require("replicate")},8338:(a,b,c)=>{c.r(b),c.d(b,{addParticipant:()=>n,addStateListener:()=>k,getGameState:()=>h,getParticipantBySocketId:()=>s,getParticipantByToken:()=>r,getTokenBySocketId:()=>t,removeParticipant:()=>o,setGameState:()=>j,setOnTimerZeroCallback:()=>g,updateGameState:()=>i,updateParticipant:()=>p,updateParticipantBySocketId:()=>q});let d={round:0,theme:"",timer:60,isTimerRunning:!1,status:"IDLE",participants:{},validTokens:[],expectedParticipantCount:0,votingTimer:120,timerStartTime:null,votingTimerStartTime:null,generationTriggered:!1},e=new Set,f=null,g=a=>{f=a},h=()=>{let a={...d};if(a.isTimerRunning&&a.timerStartTime){let b=Math.floor((Date.now()-a.timerStartTime)/1e3),c=Math.max(0,a.timer-b);a.timer=c,c<=0&&"WRITING"===a.status&&!a.generationTriggered&&(console.log("[GameState] Timer reached zero in getGameState(), triggering generation"),a.isTimerRunning=!1,a.status="GENERATING",a.generationTriggered=!0,d={...d,...a},f?(console.log("[GameState] Calling onTimerZeroCallback"),f(a).catch(a=>{console.error("[GameState] Error triggering generation:",a)})):console.warn("[GameState] No onTimerZeroCallback set!"),l())}if("VOTING"===a.status&&a.votingTimerStartTime){let b=Math.floor((Date.now()-a.votingTimerStartTime)/1e3),c=Math.max(0,a.votingTimer-b);a.votingTimer=c,0===c&&(a.status="ENDED")}return a},i=a=>(d={...d,...a},("WAITING_FOR_PLAYERS"===a.status||"WRITING"===a.status)&&(d.generationTriggered=!1),"WAITING_FOR_PLAYERS"===a.status&&a.participants&&0===Object.keys(a.participants).length&&(console.log("[GameState] New round started, clearing tokenToSocketIdMap and resetting sessionSecrets"),m={}),a.validTokens&&console.log("[GameState] Valid tokens updated:",a.validTokens),l(),d),j=a=>(d={...a},l(),d),k=a=>(e.add(a),()=>e.delete(a)),l=()=>{let a=h();e.forEach(b=>{try{b(a)}catch(a){console.error("Error in state listener:",a)}})},m={},n=(a,b,c=null)=>{let e=b.token;if(!e)return console.error("[GameState] Cannot add participant without token"),d;let f=d.participants[e];if(f){if(c){if(f.sessionSecret!==c)throw console.error(`[GameState] Rejoin rejected: sessionSecret mismatch for token ${e}`),Error("INVALID_SESSION_SECRET");console.log(`[GameState] Valid rejoin for token ${e}, updating socketId from ${f.socketId} to ${a}`)}else throw console.error(`[GameState] Rejoin rejected: no sessionSecret provided for existing token ${e}`),Error("SESSION_SECRET_REQUIRED");let b=f.socketId;b&&m[b]===e&&delete m[b]}else b.sessionSecret=`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}_${Math.random().toString(36).substring(2,15)}`,console.log(`[GameState] New participant, generated sessionSecret for token ${e}`);return d.participants[e]={...b,socketId:a,id:e,sessionSecret:f?.sessionSecret||b.sessionSecret},m[a]=e,console.log(`[GameState] Participant added/updated: token=${e}, socketId=${a}, total participants: ${Object.keys(d.participants).length}`),l(),d},o=a=>{let b=m[a];return b&&d.participants[b]&&(delete d.participants[b],delete m[a],console.log(`[GameState] Participant removed: token=${b}, socketId=${a}`),l()),d},p=(a,b)=>(d.participants[a]?(d.participants[a]={...d.participants[a],...b},l()):console.warn(`[GameState] Cannot update participant: token ${a} not found`),d),q=(a,b)=>{let c=m[a];return c?p(c,b):(console.warn(`[GameState] Cannot update participant: socketId ${a} not found in mapping`),d)},r=a=>d.participants[a]||null,s=a=>{let b=m[a];return b?d.participants[b]:null},t=a=>m[a]||null}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=6736));module.exports=c})();